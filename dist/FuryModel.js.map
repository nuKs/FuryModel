{"version":3,"sources":["FuryModel.js","FuryFactory.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1VA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"FuryModel.js","sourcesContent":["(function(FuryCallStack) {\n  'use strict';\n\n  function FuryModel(pk) {\n    this._isLoaded = false;\n    this._isLoading = false;\n\n    this._remoteData = null;\n    this._eventQueue = {\n      'loaded': [],\n      'created': [],\n      'deleted': []\n    };\n\n    this._updateFnStack = new FuryCallStack({\n      object: this\n    });\n    this._updateFnStack.push({\n      fn: this._update\n    });\n    this._createFnStack = new FuryCallStack({\n      object: this\n    });\n    this._createFnStack.push({\n      fn: this._create\n    });\n\n    this._filteredProperties = [\n      '_updateFnStack',\n      '_createFnStack',\n      '_pk',\n      '_isLoaded',\n      '_isLoading',\n      '_remoteData',\n      '_eventQueue',\n      '_filteredProperties',\n      '_load',\n      '_init',\n      '_create',\n      '_update',\n      '_delete',\n      '_process',\n      '_unprocess',\n      '$exists',\n      '$isLoaded',\n      '$isLoading',\n      '$load',\n      '$reset',\n      '$save',\n      '$delete',\n      '$raw',\n      '$once',\n      '$pre'\n    ];\n\n    if (typeof pk === 'undefined') {\n      this._pk = null;\n    }\n    else {\n      this._pk = pk;\n    }\n\n    if (this._pk === null) {\n      this._isLoaded = true;\n      this._init();\n    }\n    else {\n      this.$load();\n    }\n  }\n  FuryModel.prototype._init = function() {\n    // may inherit\n    // responsability: define default values\n  };\n  FuryModel.prototype._load = function() {\n    // to inherit\n    // should return a promise with raw data resolved\n  };\n  FuryModel.prototype._create = function(data) {\n    // to inherit\n    // should return a promise with the primary key and created raw data as resolved values\n  };\n  FuryModel.prototype._update = function(data) {\n    // to inherit\n    // should return a promise\n  };\n  FuryModel.prototype._delete = function() {\n    // to inherit\n    // should return a promise\n  };\n  FuryModel.prototype._process = function(data) {\n    // may inherit\n    // convert some raw values to something else\n    // return processed datas\n\n    return data;\n  };\n  FuryModel.prototype._unprocess = function(object) {\n    // may inherit\n    // should return a raw object\n\n    return object;\n  };\n\n  FuryModel.prototype.$isLoaded = function() {\n    return this._isLoaded;\n  };\n  FuryModel.prototype.$isLoading = function() {\n    return this._isLoading;\n  };\n  FuryModel.prototype.$exists = function() {\n    return this._pk !== null;\n  };\n\n  FuryModel.prototype.$load = function() {\n    var self = this;\n    if (this.$isLoaded()) {\n      return when.resolve(this);\n    }\n    else if (this.$isLoading()) {\n      return when.promise(function(resolve) {\n        self.$once('loaded', function() {\n          resolve(self);\n        }); // @todo manage loading error\n      });\n    }\n    else {\n      self._isLoading = true;\n\n      return this\n      ._load()\n      .then(function(raw) {\n        self._isLoading = false;\n        self._isLoaded = true;\n        self._remoteData = raw;\n\n        _setProperties(self, self._process(raw), false);\n        return _callEventsOnce(self._eventQueue, 'loaded', self);\n      });\n    }\n  };\n\n  FuryModel.prototype.$reset = function() {\n    var fieldToRemove = Array.prototype.slice.call(arguments);\n\n    Object.keys(this)\n    .filter(function(prop) {\n      if (this._filteredProperties.indexOf(prop) !== -1) {\n        return false;\n      }\n      else if (fieldToRemove.length && fieldToRemove.indexOf(prop) === -1) {\n        return false;\n      }\n      else {\n        return true;\n      }\n    }, this)\n    .forEach(function(prop) {\n      if (!this._remoteObject || typeof this._remoteObject[prop] === 'undefined') {\n        delete this[prop];\n      }\n      else {\n        this[prop] = this._remoteObject[prop]; // @todo deep copy\n      }\n    }, this);\n  };\n\n  FuryModel.prototype.$save = function(data) {\n    var self = this;\n    if (!this.$exists()) {\n      return this\n        ._createFnStack.exec({\n          args: [data || this.$raw()]\n        })\n        .then(function(result) {\n          var pk = result[0],\n              raw = result[1];\n\n          self._pk = pk;\n          self._remoteData = raw;\n\n          _setProperties(self, self._process(raw), false);\n\n          return _callEventsOnce(self._eventQueue, 'created', self)\n          .then(_callEventsOnce.bind(undefined, self._eventQueue, 'loaded', self));\n        });\n    }\n    else {\n      return this\n        ._updateFnStack.exec({\n          args: [data || this.$raw()]\n        })\n        .then(function(result) {\n          _setProperties(self, self._process(result), false);\n\n          self._remoteData = self.$raw(true); // @proposal optimize\n\n          return when.resolve(self);\n        });\n    }\n  };\n  FuryModel.prototype.$delete = function() {\n    var self = this;\n    return this\n      ._delete()\n      .then(function() {\n        self._pk = null;\n        self._remoteData = null;\n        return _callEventsOnce(self._eventQueue, 'deleted');\n      });\n  };\n  FuryModel.prototype.$raw = function(enableUnprocess) {\n    // @note properties are not deep copied\n\n    var rawObject = {};\n\n    if (typeof enableUnprocess === 'undefined') {\n      enableUnprocess = true;\n    }\n\n    Object\n    .keys(this)\n    .filter(function(key) {\n      return this._filteredProperties.indexOf(key) === -1;\n    }, this)\n    .forEach(function(key) {\n      rawObject[key] = this[key];\n    }, this);\n\n    if (enableUnprocess) {\n      rawObject = this._unprocess(rawObject);\n    }\n\n    return rawObject;\n  };\n  FuryModel.prototype.$once = function(eventName, fn) {\n    if (!this._eventQueue[eventName]) {\n      throw new Error(eventName + ' is not a valid event');\n    }\n\n    this._eventQueue[eventName].push(fn);\n  };\n\n  FuryModel.prototype.$pre = function(aspectName, fn) {\n    switch (aspectName) {\n      case 'save':\n        this._updateFnStack.push({\n          fn: fn\n        });\n        this._createFnStack.push({\n          fn: fn\n        });\n        break;\n      default:\n        throw new Error(aspectName + ' is not a valid aspect');\n    }\n\n    return this;\n  };\n\n  function _callEventsOnce(eventQueue, eventName, param) {\n    var queue = eventQueue[eventName];\n\n    var result = when\n    .sequence(queue, param)\n    .then(function() {\n      return when.resolve(param);\n    });\n\n    eventQueue[eventName] = [];\n\n    return result;\n  }\n\n  function _setProperties(object, properties, override) {\n    if (typeof override === 'undefined') {\n      override = false;\n    }\n\n    var toEdit = Object.keys(properties);\n\n    if (!override) {\n      toEdit = toEdit.filter(function(prop) {\n        return typeof object[prop] === 'undefined';\n      });\n    }\n\n    toEdit.forEach(function(prop) {\n      object[prop] = properties[prop];\n    });\n  }\n\n  FuryModel.define = function(opts) {\n    opts = opts || {};\n\n    var definableProperties = [\n      '_constructor',\n      '_init',\n      '_load',\n      '_create',\n      '_update',\n      '_delete',\n      '_process',\n      '_unprocess'\n    ];\n\n    var FuryModelExtended;\n\n    if (typeof opts._constructor !== 'undefined') {\n      FuryModelExtended = opts._constructor;\n    }\n    else {\n      FuryModelExtended = function(pk) {\n        FuryModel.call(this, pk);\n      };\n    }\n\n    FuryModelExtended.prototype = Object.create(FuryModel.prototype);\n    FuryModelExtended.prototype.constructor = FuryModelExtended;\n\n    Object\n    .keys(opts)\n    .filter(function(prop) {\n      if (definableProperties.indexOf(prop) === -1) {\n        throw new Error('property ' + prop + ' is not definable');\n      }\n      if (typeof opts[prop] !== 'function') {\n        throw new Error('property ' + prop + ' should be a function');\n      }\n\n      return prop !== '_constructor';\n    })\n    .forEach(function(prop) {\n      FuryModelExtended.prototype[prop] = opts[prop];\n    });\n\n    return FuryModelExtended;\n  };\n\n  if (typeof exports !== 'undefined') {\n    exports = FuryModel;\n  }\n  else {\n    window.FuryModel = FuryModel;\n  }\n\n})(window.FuryCallStack);","(function() {\n  'use strict';\n\n  function FuryFactory(model) {\n    this._model = model;\n    this._instances = {};\n  }\n\n  FuryFactory.prototype.create = function() {\n    var self = this,\n        instance = new this._model();\n\n    instance.$once('created', function() {\n      self._instances[instance._pk] = instance;\n    });\n\n    return instance;\n  };\n  FuryFactory.prototype.get = function(pk) {\n    var self = this;\n\n    if (typeof this._instances[pk] === 'undefined') {\n      this._instances[pk] = new this._model(pk);\n\n      this._instances[pk].$once('deleted', function() {\n        delete self._instances[pk];\n      });\n    }\n\n    return this._instances[pk];\n  };\n\n\n  FuryFactory.define = function(model, opts) {\n    var FuryFactoryExtended;\n\n    if (typeof opts._constructor !== 'undefined') {\n      FuryFactoryExtended = opts._constructor;\n    }\n    else {\n      FuryFactoryExtended = function(model) {\n        FuryFactory.call(this, model);\n      };\n    }\n\n    FuryFactoryExtended.prototype = Object.create(FuryFactory.prototype);\n    FuryFactoryExtended.prototype.constructor = FuryFactoryExtended;\n\n    Object\n    .keys(opts)\n    .filter(function(prop) {\n      return prop !== '_constructor';\n    })\n    .forEach(function(prop) {\n      FuryFactoryExtended.prototype[prop] = opts[prop];\n    });\n\n    return new FuryFactoryExtended(model);\n\n  };\n\n  if (typeof exports !== 'undefined') {\n    exports = FuryFactory;\n  }\n  else {\n    window.FuryFactory = FuryFactory;\n  }\n\n})();"],"sourceRoot":"/source/"}