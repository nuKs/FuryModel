!function(t){"use strict";function e(e){this._isLoaded=!1,this._isLoading=!1,this._remoteData=null,this._eventQueue={loaded:[],created:[],deleted:[]},this._updateFnStack=new t({object:this}),this._updateFnStack.push({fn:this._update}),this._createFnStack=new t({object:this}),this._createFnStack.push({fn:this._create}),this._filteredProperties=["_updateFnStack","_createFnStack","_pk","_isLoaded","_isLoading","_remoteData","_eventQueue","_filteredProperties","_load","_init","_create","_update","_delete","_process","_unprocess","$exists","$isLoaded","$isLoading","$load","$reset","$save","$delete","$raw","$once","$pre"],this._pk="undefined"==typeof e?null:e,null===this._pk?(this._isLoaded=!0,this._init()):this.$load()}function n(t,e,n){var o=t[e],r=when.sequence(o,n).then(function(){return when.resolve(n)});return t[e]=[],r}function o(t,e,n){"undefined"==typeof n&&(n=!1);var o=Object.keys(e);n||(o=o.filter(function(e){return"undefined"==typeof t[e]})),o.forEach(function(n){t[n]=e[n]})}e.prototype._init=function(){},e.prototype._load=function(){},e.prototype._create=function(){},e.prototype._update=function(){},e.prototype._delete=function(){},e.prototype._process=function(t){return t},e.prototype._unprocess=function(t){return t},e.prototype.$isLoaded=function(){return this._isLoaded},e.prototype.$isLoading=function(){return this._isLoading},e.prototype.$exists=function(){return null!==this._pk},e.prototype.$load=function(){var t=this;return this.$isLoaded()?when.resolve(this):this.$isLoading()?when.promise(function(e){t.$once("loaded",function(){e(t)})}):(t._isLoading=!0,this._load().then(function(e){return t._isLoading=!1,t._isLoaded=!0,t._remoteData=e,o(t,t._process(e),!1),n(t._eventQueue,"loaded",t)}))},e.prototype.$reset=function(){var t=Array.prototype.slice.call(arguments);Object.keys(this).filter(function(e){return-1!==this._filteredProperties.indexOf(e)?!1:t.length&&-1===t.indexOf(e)?!1:!0},this).forEach(function(t){this._remoteObject&&"undefined"!=typeof this._remoteObject[t]?this[t]=this._remoteObject[t]:delete this[t]},this)},e.prototype.$save=function(t){var e=this;return this.$exists()?this._updateFnStack.exec({args:[t||this.$raw()]}).then(function(t){return o(e,e._process(t),!1),e._remoteData=e.$raw(!0),when.resolve(e)}):this._createFnStack.exec({args:[t||this.$raw()]}).then(function(t){var r=t[0],i=t[1];return e._pk=r,e._remoteData=i,o(e,e._process(i),!1),n(e._eventQueue,"created",e).then(n.bind(void 0,e._eventQueue,"loaded",e))})},e.prototype.$delete=function(){var t=this;return this._delete().then(function(){return t._pk=null,t._remoteData=null,n(t._eventQueue,"deleted")})},e.prototype.$raw=function(t){var e={};return"undefined"==typeof t&&(t=!0),Object.keys(this).filter(function(t){return-1===this._filteredProperties.indexOf(t)},this).forEach(function(t){e[t]=this[t]},this),t&&(e=this._unprocess(e)),e},e.prototype.$once=function(t,e){if(!this._eventQueue[t])throw new Error(t+" is not a valid event");this._eventQueue[t].push(e)},e.prototype.$pre=function(t,e){switch(t){case"save":this._updateFnStack.push({fn:e}),this._createFnStack.push({fn:e});break;default:throw new Error(t+" is not a valid aspect")}return this},e.define=function(t){t=t||{};var n,o=["_constructor","_init","_load","_create","_update","_delete","_process","_unprocess"];return n="undefined"!=typeof t._constructor?t._constructor:function(t){e.call(this,t)},n.prototype=Object.create(e.prototype),n.prototype.constructor=n,Object.keys(t).filter(function(e){if(-1===o.indexOf(e))throw new Error("property "+e+" is not definable");if("function"!=typeof t[e])throw new Error("property "+e+" should be a function");return"_constructor"!==e}).forEach(function(e){n.prototype[e]=t[e]}),n},"undefined"!=typeof exports?exports=e:window.FuryModel=e}(window.FuryCallStack),function(){"use strict";function t(t){this._model=t,this._instances={}}t.prototype.create=function(){var t=this,e=new this._model;return e.$once("created",function(){t._instances[e._pk]=e}),e},t.prototype.get=function(t){var e=this;return"undefined"==typeof this._instances[t]&&(this._instances[t]=new this._model(t),this._instances[t].$once("deleted",function(){delete e._instances[t]})),this._instances[t]},t.define=function(e,n){var o;return o="undefined"!=typeof n._constructor?n._constructor:function(e){t.call(this,e)},o.prototype=Object.create(t.prototype),o.prototype.constructor=o,Object.keys(n).filter(function(t){return"_constructor"!==t}).forEach(function(t){o.prototype[t]=n[t]}),new o(e)},"undefined"!=typeof exports?exports=t:window.FuryFactory=t}();
//# sourceMappingURL=FuryModel.min.js.map